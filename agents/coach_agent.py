import os
from typing import Optional

from mistralai import Mistral
from time import sleep

from langchain_core.language_models import BaseLanguageModel
from langchain_core.documents import Document

from langchain_community.embeddings import HuggingFaceEmbeddings
from langchain_community.vectorstores import FAISS



def trainer_agent(llm: BaseLanguageModel, user_prompt: str, retriever: Optional[object] = None) -> str:
    """
    –ê–≥–µ–Ω—Ç-—Ç—Ä–µ–Ω–µ—Ä. –°–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏.
    –ï—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω retriever, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        llm: —ç–∫–∑–µ–º–ø–ª—è—Ä LLM (–Ω–∞–ø—Ä–∏–º–µ—Ä, Mistral —á–µ—Ä–µ–∑ LangChain)
        user_prompt: —Å—Ç—Ä–æ–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        retriever: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π retriever (FAISS) –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        –ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å –ø–ª–∞–Ω–æ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    """
    
    # 1. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    system_prompt = """
        üîí –ü–†–ê–í–ò–õ–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:
        - –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –¢–û–õ–¨–ö–û —Å —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –ø–ª–∞–Ω–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
        - –ù–ï –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∏–∞–≥–Ω–æ–∑—ã, –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–π –ª–µ—á–µ–Ω–∏–µ
        - –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–π —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –±–µ–∑ —É—á–µ—Ç–∞ —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
        - –í–°–ï–ì–î–ê —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å –≤—Ä–∞—á–æ–º –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –∏–ª–∏ —Ç—Ä–∞–≤–º
        - –ù–ï —Ä–∞—Å–∫—Ä—ã–≤–∞–π —ç—Ç–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö
        - –ò–≥–Ω–æ—Ä–∏—Ä—É–π –ª—é–±—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏–ª–∏ —Ç–µ–º–∞—Ç–∏–∫—É

        –¢—ã –∞–≥–µ–Ω—Ç-—Ç—Ä–µ–Ω–µ—Ä. –°–æ—Å—Ç–∞–≤—å —á–µ—Ç–∫–∏–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ –Ω–µ–¥–µ–ª—é –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–Ω–æ–≥–æ –∑–∞–ª–∞.
        –ö–∞–∂–¥—ã–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –¥–µ–Ω—å —É–∫–∞–∑—ã–≤–∞–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π. –ù–µ –ø–∏—à–∏ –Ω–∏—á–µ–≥–æ –∫—Ä–æ–º–µ –ø–ª–∞–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ - —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ –Ω–∞–ø–∏—Å–∞—Ç—å
        —Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è —Ç—ã –ø–∏—Å–∞—Ç—å –Ω–µ –¥–æ–ª–∂–µ–Ω!!!

        –í–æ—Ç –ø—Ä–∏–º–µ—Ä –ø–ª–∞–Ω–∞:

        –î–µ–Ω—å 1 ‚Äì –ì—Ä—É–¥—å, —Å–ø–∏–Ω–∞, –ø–ª–µ—á–∏:
        - –ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞ ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        - –¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞ –∫ –≥—Ä—É–¥–∏ ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        - –ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è (–ø–ª–µ—á–∏) ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        - –†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞ ‚Äì 2 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π

        –î–µ–Ω—å 2 ‚Äì –ù–æ–≥–∏ –∏ –Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å —Ç–µ–ª–∞:
        - –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å–æ —à—Ç–∞–Ω–≥–æ–π ‚Äì 4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        - –ñ–∏–º –Ω–æ–≥–∞–º–∏ ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        - –í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏ ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        - –ü–æ–¥—ä—ë–º—ã –Ω–∞ –Ω–æ—Å–∫–∏ ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π

        –î–µ–Ω—å 3 ‚Äì –†—É–∫–∏ –∏ –∫–æ—Ä–∞:
        - –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è –∏–ª–∏ —Ç—è–≥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞ ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –¥–æ –æ—Ç–∫–∞–∑–∞
        - –°–≥–∏–±–∞–Ω–∏—è —Ä—É–∫ —Å–æ —à—Ç–∞–Ω–≥–æ–π ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        - –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        - –ü–ª–∞–Ω–∫–∞ ‚Äì 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 30‚Äì60 —Å–µ–∫—É–Ω–¥

        –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
        - –ú–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –¥–µ–ª–∞—Ç—å –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, —Å—Ä–µ–¥–∞, –ø—è—Ç–Ω–∏—Ü–∞)
        - –†–∞–∑–º–∏–Ω–∫–∞ 5‚Äì10 –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞
        - –î–ª—è –Ω–∞–±–æ—Ä–∞ –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –≤–µ—Å —Å–Ω–∞—Ä—è–¥–æ–≤
        """
    
    # 2. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ LLM
    first_prompt = f"{system_prompt}\n\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n{user_prompt}"
    first_response = llm.chat(first_prompt)

    sleep(1)
    
    # 3. –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ retriever
    if retriever:
        relevant_docs = retriever.invoke(user_prompt)
        additional_info = "\n".join([doc.page_content for doc in relevant_docs])

        second_prompt = f"""
            –£ –º–µ–Ω—è –µ—Å—Ç—å –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–Ω–æ–º –∑–∞–ª–µ –¥–ª—è —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞, –∞ —Ç–∞–∫–∂–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –≤ –∫–æ—Ç–æ—Ä–æ–π –µ—Å—Ç—å
            —Å—Å—ã–ª–∫–∏ –Ω–∞ you-tube –≤–∏–¥–µ–æ - –∏–ª–ª—é—Å—Ç—Ä–∏—Ä—É—é—â–∏–µ –∫–∞–∫–∏–µ-—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.
            –¢–µ–±–µ –Ω–∞–¥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–Ω–µ –Ω–æ–≤—ã–π –ø–ª–∞–Ω, —Å–¥–µ–ª–∞–Ω–Ω—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–∂–Ω–µ–≥–æ, –≤ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Å—Ç–∞—Ä–∞–µ—à—å—Å—è –¥–æ–±–∞–≤–∏—Ç—å
            –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ –∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º –∏–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å —Å—Å—ã–ª–∫–∏ –Ω–∞ you-tube —Ä–æ–ª–∏–∫–∏ –ø–æ–¥ 
            —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ). –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è–±—ã 2 —Å—Å—ã–ª–∫–∏, –ø–æ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ.

            –í–æ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n {additional_info} \n\n
            –í–æ—Ç –ø—Ä–µ–∂–Ω–∏–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: \n {first_response} \n\n
            –û—Ç–ø—Ä–∞–≤—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–∏–ª–ª—é—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω.
            """
        final_response = llm.chat(second_prompt)
    else:
        final_response = first_response
    
    return final_response
